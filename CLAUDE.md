# CLAUDE.md

Этот файл содержит руководство для Claude Code (claude.ai/code) при работе с кодом в данном репозитории.

## Обзор проекта

Система мониторинга объектов культурного наследия (ОКН) в городе Каменск-Уральский, состоящая из:

1. **Веб-приложение** - отображает статистику в реальном времени, получая данные из Google Таблиц
2. **Telegram бот** - автоматически публикует новые анкеты волонтеров в Telegram канал @monitoringokn

## Команды разработки

### Запуск веб-приложения
```bash
# НОВАЯ ВЕРСИЯ (когда будет готова):
cd web && python -m http.server 8000
# или
cd web && npx serve .

# СТАРАЯ ВЕРСИЯ (только для справки):
cd web_old && python -m http.server 8001
```

### Запуск Telegram бота
```bash
# Установка зависимостей
cd bot && pip install -r requirements.txt

# Запуск бота
python index.py
```

### Тестирование загрузки данных
- Откройте консоль разработчика браузера для просмотра подробных логов
- Приложение автоматически обновляет данные каждые 5 минут
- Используйте кнопку "Повторить" для ручной перезагрузки данных при ошибках

## Архитектура

### Структура файлов
```
Monitoring/
├── web/                    # НОВОЕ веб-приложение (в разработке)
│   └── (будет создано согласно техтребованиям)
├── web_old/               # СТАРАЯ версия - ТОЛЬКО ДЛЯ СПРАВКИ
│   ├── index.html         # НЕ ИСПОЛЬЗОВАТЬ для разработки
│   ├── script.js          # ТОЛЬКО для справки по работе с данными
│   ├── styles.css         # НЕ ИСПОЛЬЗОВАТЬ для разработки
│   ├── images/            # SVG иконки - можно копировать в новую версию
│   ├── README.md          # Документация старой версии
│   └── README_OLD.md      # ВАЖНО: инструкции по использованию
├── bot/                   # Telegram бот для автопубликации
│   ├── index.py          # Основной код бота
│   └── requirements.txt  # Зависимости Python
├── design/                # Дизайн-макеты для разработки
│   └── prototype/        # PNG макеты интерфейса
├── docs/                  # Документация и примеры данных
├── .env                  # Конфигурация (токены, ID каналов)
└── CLAUDE.md             # Этот файл
```

**⚠️ ВАЖНО ДЛЯ РАЗРАБОТКИ:**
- Папка `web_old/` - ТОЛЬКО для справки по методам получения данных
- Вся новая разработка ведется в папке `web/` с нуля
- Использовать дизайн-макеты из `design/prototype/` и данные из `docs/`

### Основные компоненты

**НОВОЕ Веб-приложение (`web/`):**
- В разработке согласно техническим требованиям
- Современный интерфейс на основе дизайн-макетов
- Упрощенная версия без карты и временной шкалы

**СТАРОЕ Веб-приложение (`web_old/script.js`) - ТОЛЬКО ДЛЯ СПРАВКИ:**
- `loadData()` - Основная функция загрузки данных через Google Sheets API
- `parseCSV()` - Кастомный парсер CSV, обрабатывающий поля в кавычках
- `analyzeData()` - Обрабатывает сырые данные и категоризирует объекты по состоянию
- `getCondition()` - Преобразует русские термины состояния в категории

**Компоненты интерфейса:**
- Отображение статистики с анимированными счетчиками
- Сетка объектов, показывающая отдельные объекты наследия как карточки
- Вкладки фильтров (Состояние/Материал) - в настоящее время работает только "Состояние"
- Обработка ошибок с функцией повтора

**Telegram бот (`bot/index.py`):**
- `print_new_posts()` - Основная функция публикации новых анкет в канал
- `form_message()` - Формирует сообщения с данными об объектах и ссылками на фотографии
- `compress_image()` - Сжимает и конвертирует изображения (включая HEIC → JPEG)
- `daily_job()` - Ежедневная сводка о проделанной работе волонтеров
- Автоматическая обработка изображений из Google Drive
- Поддержка команды `/id` для получения chat_id

**Интеграция с источником данных:**

*Веб-приложение:*
- ID Google Таблицы: `1o7-XTymP0__T2fNd0wYuw3NrrCCX8GlvOThlj8UHwAA`
- Название листа: `Данные` (настроено в константе `SHEET_NAME`)
- Использует Google Visualization API для получения CSV данных без аутентификации

*Telegram бот:*
- ID документа с анкетами: `1Dh0II0tsPafRACtJohfH3rYqhS8iYoas135mDiIpjYw` (из `.env`)
- Листы: "Ответы" (ID: 1194509703), "Данные" (ID: 1530376561), "Маппинг колонок" (ID: 2098432719)
- Использует Google Sheets API v4 и Drive API с service account аутентификацией
- Требует файл `monitoringokn-bba1ad0ed8e5.json` для доступа к API

### Ключевое сопоставление данных

Приложение ожидает следующие колонки из Google Таблицы:
- `Город` или `A` - Название города (для подсчета общего количества объектов)
- `Название` или `C` - Название объекта
- `Год` или `B` - Год постройки
- `Адрес` или `D` - Адрес
- `Статус` или `E` - Статус состояния
- `Иконка` - Тип иконки для визуального представления

**Сопоставление статусов:**
- `готово`/`хорошее` → `good` (зеленый)
- `проверяем`/`нормальное` → `normal` (желтый)  
- `плохое` → `bad` (оранжевый)
- `руины` → `ruins` (красный)
- `не существует` → `not-exists` (серый)

**Типы иконок:**
Доступные SVG иконки в `images/`: bridge (мост), church (церковь), palace (дворец), house (дом), apartment (многоэтажка), gate (ворота), barn (сарай), ensemble (ансамбль)

## Конфигурация

### Настройка веб-приложения
- Для публичных таблиц: API ключ не нужен (текущая настройка)
- Для приватных таблиц: Установите константу `API_KEY` в `script.js`
- Измените константы `SPREADSHEET_ID` и `SHEET_NAME` для указания на другие источники данных

### Интервал автообновления
Измените функцию `startAutoRefresh()` - в настоящее время установлен на 5 минут (300000мс)

### Конфигурация Telegram бота (`.env`)
```env
BOT_TOKEN="токен_telegram_бота"           # Токен от @BotFather
DOC_ID="id_таблицы_с_анкетами"            # Google Таблица с анкетами волонтеров
MAIN_CHAT_ID=-числовой_id                 # ID основного канала для публикации
ADMIN_CHAT_ID=-числовой_id                # ID чата администратора для уведомлений
PREUPLOAD_CHAT_ID=-числовой_id            # ID чата для предварительной загрузки
```

### Требования для бота
- Файл `monitoringokn-bba1ad0ed8e5.json` - service account credentials для Google API
- Python зависимости из `requirements.txt`
- Доступ к Google Sheets API и Google Drive API
- Права администратора в целевом Telegram канале

## Язык интерфейса и стили

- **Язык**: Русский интерфейс с кириллическим текстом
- **Дизайн**: Современный градиентный фон, карточная компоновка с hover-эффектами
- **Шрифт**: Inter из Google Fonts
- **Адаптивность**: Мобильно-дружественный с CSS Grid и Flexbox
- **Анимации**: Плавные переходы и состояния загрузки

## Особенности работы Telegram бота

### Процесс публикации
- Проверяет новые записи в таблице "Ответы" каждые 150 секунд
- Скачивает изображения из Google Drive по ссылкам из анкет
- Автоматически сжимает изображения (макс. размер 4000px) и конвертирует HEIC в JPEG
- Публикует сначала медиагруппу с фотографиями, затем текстовое сообщение со ссылкой
- Обновляет таблицу ссылкой на опубликованный пост
- Пауза 300 секунд между постами для избежания спама

### Ежедневные сводки
- Запускается в 4:00 UTC (9:00 по местному времени)
- Показывает количество отмониторенных объектов за предыдущий день
- Отображает общий прогресс проекта в процентах
- Отправляется только при наличии новых объектов

### Команды бота
- `/id` - получить chat_id текущего чата

### Обработка ошибок

**Веб-приложение:**
- Таймауты сети (лимит 30 секунд)
- Ошибки парсинга CSV с подробным логированием в консоль  
- Валидация пустых данных
- Визуальные состояния ошибок с функцией повтора
- Все ошибки логируются в консоль браузера для отладки

**Telegram бот:**
- Ошибки загрузки медиафайлов логируются в таблицу и отправляются админу
- При сбоях сети пауза 1000 секунд перед повторной попыткой
- Автоматическая очистка скачанных файлов после публикации
- Graceful обработка ошибок сжатия изображений с fallback вариантами